# 一、基础信息设置页

## 1.1. 初始化

使用 el-tabs 绘画出标签页（选项卡样式）并且给每个选项创建一个组件

```vue
<template>
	<div>
    <el-tabs v-model="activeName" type="card" >
       <el-tab-pane label="部门管理" name="first">
          <dep-mana/>
      </el-tab-pane>
        <el-tab-pane label="职位管理" name="second">
          <pos-mana/>
      </el-tab-pane>
        <el-tab-pane label="职称管理" name="third">
          <job-level-mana/>
      </el-tab-pane>
        <el-tab-pane label="奖惩规则" name="fourth">
          <ec-mana/>
      </el-tab-pane>
        <el-tab-pane label="权限组" name="five">
          <permiss-mana/>
      </el-tab-pane>
    </el-tabs>
  </div>
</template>
 
<script>
  import DepMana from "@/components/sys/basic/DepMana";
  import PosMana from "@/components/sys/basic/PosMana";
  import JobLevelMana from "@//components/sys/basic/JobLevelMana";
  import EcMana from "@/components/sys/basic/EcMana";
  import PermissMana from "@/components/sys/basic/PermissMana";
  export default {
    name: "SysBasic",
    components: {PermissMana, EcMana, JobLevelMana, PosMana, DepMana},
    data(){
      return{
        activeName: 'first'
      }
    }
  }
</script>
```

## 1.2. 职位管理开发

### 1.2.1. 职位管理 - 前端组件开发

这里是初步开发组件，主要是为了一个展示效果

注意：表单数据内容需要和后端的类属性对应

```vue
<template>
<div>
  <div>
    <!-- 表单输入框 -->
    <el-input
              size="small"
              class="addPosInput"
              placeholder="添加职位..."
              prefix-icon="el-icon-plus"
              v-model="pos.name">
  </el-input>
    <el-button icon="el-icon-plus" size="small" type="primary">添加</el-button>
  </div>
  <div class="posManaMain">
    <!-- 展示职位的表格 -->
    <el-table
              :data="positions"
              stripe
              size="small"
              border
              style="width: 70%">
      <el-table-column
                       prop="id"
                       label="编号"
                       width="50">
  </el-table-column>
      <el-table-column
                       prop="name"
                       label="职位名称"
                       width="120">
  </el-table-column>
      <el-table-column
                       prop="createDate"
                       label="创建时间">
  </el-table-column>
  </el-table>
  </div>
  </div>
</template>

<script>
  export default {
    name: "PosMana",
    data() {
      return {
        pos: {
          name: '',
        },
        positions: []
      }
    }
  }
</script>

<style scoped>
  .addPosInput {
    width: 300px;
    margin-right: 5px;
  }
  .posManaMain{
    margin-top: 5px;
  }
</style>
```

### 1.2.2. 职位管理 - 后端接口开发

规范：需遵循Result风格

接口需求：

* 增 
* 删
* 改
* 查

Controller层

```java
// 注意因为我们的权限url是从数据库获取的，所以url必须要适配数据库中的url
@RestController
@RequestMapping("/system/basic/pos")
public class PositionController {

  @Autowired
  PositionService positionService;

  /* 查 */
  @GetMapping("/")
  public List<Position> getAllPositions() {
    return positionService.getAllPositions();
  }

  /* 增 */
  @PostMapping("/")
  public RespBean addPosition(@RequestBody Position position) {
    if (positionService.addPosition(position) == 1) {
      return RespBean.ok("添加成功！");
    }
    return RespBean.error("添加失败！");
  }

  /* 改 */
  @PutMapping("/")
  public RespBean updatePositions(@RequestBody Position position) {
    if (positionService.updatePositions(position) == 1) {
      return RespBean.ok("更新成功！");
    }
    return RespBean.error("更新失败！");
  }

  /* 删 */
  @DeleteMapping("/{id}")
  public RespBean deletePositionById(@PathVariable Integer id) {
    if (positionService.deletePositionById(id) == 1) {
      return RespBean.ok("删除成功！");
    }
    return RespBean.error("删除失败！");
  }
}
```

Service层

* 这里除了第一个查找的sql语句是自己写的其余的都是使用第三方Mybatis-Plus自动生成的sql方法

```java
@Service
public class PositionService {

  @Autowired
  PositionMapper positionMapper;

  public List<Position> getAllPositions() {
    return positionMapper.getAllPositions();
  }

  public Integer addPosition(Position position) {
    position.setEnabled(true);
    position.setCreateDate(new Date());
    return positionMapper.insertSelective(position);
  }

  public Integer updatePositions(Position position) {
    return positionMapper.updateByPrimaryKeySelective(position);
  }

  public int deletePositionById(Integer id) {
    return positionMapper.deleteByPrimaryKey(id);
  }
}
```

Mapper层

```xml
<select id="getAllPositions" resultMap="BaseResultMap">
  select * from position
</select>
```

### 1.2.3. 职位管理 - 前端调用后端接口

注意：

* 在点击编辑出现弹窗进行操作的时候出现问题如下

```js
// 出现问题: 当直接将data赋值给updatePos时，updatePos 和 pos 的数据会捆绑在一起,input输入的时候表格中的数据会随着发生变化
// 解决方法: 使用 Object.assign(目标，源数据) 将pos数据复制到updatePos即可，这样在就不会造成数据捆绑的现象
```

添加部分组件：

* 两行 `el-table-column` 一个用于是否全选；一个用于操作行（编辑、删除）
* 一个 `el-dialog` 弹出窗，点击编辑弹出此窗口

```html
<div>
  <el-table
            :data="positions"
            stripe
            size="small"
            border
            style="width: 70%">
    <el-table-column
                     type="selection"
                     width="55">
    </el-table-column>
    <el-table-column
                     prop="id"
                     label="编号"
                     width="50">
    </el-table-column>
    <el-table-column
                     prop="name"
                     label="职位名称"
                     width="180">
    </el-table-column>
    <el-table-column
                     prop="createDate"
                     width="150px"
                     label="创建时间">
    </el-table-column>
    <el-table-column label="操作">
      <template slot-scope="scope">
        <el-button
                   size="mini"
                   @click="showEditDialog(scope.$index, scope.row)">编辑
        </el-button>
        <el-button
                   size="mini"
                   type="danger"
                   @click="handleDelete(scope.$index, scope.row)">删除
        </el-button>
      </template>
    </el-table-column>
  </el-table>
</div>
<!-- 编辑按钮弹窗 -->
<el-dialog
           title="修改职位"
           :visible.sync="dialogVisible"
           width="30%">
  <div>
    <el-tag>职位名称</el-tag>
    <el-input class="updatePosInput" size="small" v-model="updatePos.name" @keydown.enter.native="doUpdate"></el-input>
  </div>
  <span slot="footer" class="dialog-footer">
    <el-button size="small" @click="dialogVisible = false">取 消</el-button>
    <el-button size="small" type="primary"  @click="doUpdate">确 定</el-button>
  </span>
</el-dialog>
```

调用方法以及完善内容

```vue
<template>
<div>
  <div>
    <el-input
              size="small"
              class="addPosInput"
              placeholder="添加职位..."
              prefix-icon="el-icon-plus"
              @keydown.enter.native="addPosition"
              v-model="pos.name">
  </el-input>
    <el-button icon="el-icon-plus" size="small" type="primary" @click="addPosition">添加</el-button>
  </div>
  <div class="posManaMain">
    <el-table
              :data="positions"
              stripe
              size="small"
              border
              style="width: 70%">
      <el-table-column
                       type="selection"
                       width="55">
  </el-table-column>
      <el-table-column
                       prop="id"
                       label="编号"
                       width="50">
  </el-table-column>
      <el-table-column
                       prop="name"
                       label="职位名称"
                       width="180">
  </el-table-column>
      <el-table-column
                       prop="createDate"
                       width="150px"
                       label="创建时间">
  </el-table-column>
      <el-table-column label="操作">
        <template slot-scope="scope">
          <el-button
                     size="mini"
                     @click="showEditDialog(scope.$index, scope.row)">编辑
  </el-button>
          <el-button
                     size="mini"
                     type="danger"
                     @click="handleDelete(scope.$index, scope.row)">删除
  </el-button>
</template>
</el-table-column>
</el-table>
</div>
<el-dialog
           title="修改职位"
           :visible.sync="dialogVisible"
           width="30%">
  <div>
    <el-tag>职位名称</el-tag>
    <el-input class="updatePosInput" size="small" v-model="updatePos.name" @keydown.enter.native="doUpdate"></el-input>
  </div>
  <span slot="footer" class="dialog-footer">
    <el-button size="small" @click="dialogVisible = false">取 消</el-button>
    <el-button size="small" type="primary"  @click="doUpdate">确 定</el-button>
  </span>
</el-dialog>
</div>
</template>

<script>
  export default {
    name: "PosMana",
    data() {
      return {
        pos: {
          name: '',
        },
        updatePos: {
          name: '',
        },
        positions: [],
        dialogVisible: false
      }
    },
    mounted() {
      this.initPositions();
    },
    methods: {
      initPositions() {
        this.getRequest("/system/basic/pos/").then(res => {
          if (res) {
            this.positions = res;
          }
        })
      },
      showEditDialog(index, data) {
        // 出现问题: 当直接将data赋值给updatePos时，updatePos 和 pos 的数据会捆绑在一起,input输入的时候表格中的数据会随着发生变化
        // 解决方法: 使用 Object.assign(目标，源数据) 将pos数据复制到updatePos即可
        Object.assign(this.updatePos,data)
        this.dialogVisible = true
      },
      doUpdate() {
        if (this.updatePos.name) {
          this.putRequest("/system/basic/pos/", this.updatePos).then(res => {
            if (res) {
              this.initPositions()
              this.updatePos.name = ''
              this.dialogVisible = false
            }
          })
        }else{
          this.$message.error("职位名称不可为空!")
        }
      },
      handleDelete(index, data) {
        this.$confirm('此操作将永久删除【' + data.name + '】职位, 是否继续?', '提示', {
          confirmButtonText: '确定',
          cancelButtonText: '取消',
          type: 'warning'
        }).then(() => {
          this.deleteRequest("/system/basic/pos/" + data.id).then(res => {
            this.initPositions();
          })
        }).catch(() => {
          this.$message({
            type: 'info',
            message: '已取消删除'
          });
        });
      },
      addPosition() {
        if (this.pos.name) {
          this.postRequest("/system/basic/pos/", this.pos).then(res => {
            if (res) {
              this.initPositions();
              this.pos.name = ''
            }
          })
        } else {
          this.$message.error("职位名称不可为空！")
        }
      }
    }
  }
</script>

<style scoped>
  .addPosInput {
    width: 300px;
    margin-right: 5px;
  }

  .updatePosInput {
    width: 200px;
    margin-left: 8px;
  }

  .posManaMain {
    margin-top: 5px;
  }
</style>
```

### 1.2.4. 后端 - 全局异常统一处理、格式化日期

说明：在删除职位表格的时候出现报错

原因：数据库中职位存在外键，无法删除，但是前端获取不到删除失败原因，只能返回删除失败

人性化操作：出现错误原因，修改其返回的信息

首先获取错误原因（MySQLIntegrityConstraintViolationException）

![image-20200427185426917](image-20200427185426917.png)

```java
@RestControllerAdvice
public class GlobalExceptionHandler {
  @ExceptionHandler(SQLException.class)
  public RespBean sqlException(SQLException e) {
    if (e instanceof MySQLIntegrityConstraintViolationException) {
      return RespBean.error("改数据存在关联数据，操作失败！");
    }
    return RespBean.error("数据库异常，操作失败！");
  }
}
```

---

前端获取的时间格式比较复杂，我们可以前端进行格式化也可以后端进行格式化，前端格式化比较繁琐，所以我们这里采用后端格式化时间：

* 使用 `@JsonFormat` 注解，来进行格式化

```java
public class Position {
  @JsonFormat(pattern = "yyyy-MM-dd", timezone = "Asia/Shanghai")
  private Date createDate;
  
  // 省略其余属性以及set/get方法
}
```

### 1.2.5. 批量删除接口创建以及前端引用

后端：创建批量删除接口

* controller层

```java
@RestController
@RequestMapping("/system/basic/pos")
public class PositionController {

  @Autowired
  PositionService positionService;

  // 省略其余方法

  /* 批量删除 */
  @DeleteMapping("/") // 接收数组形式的参数
  public RespBean deletePositionsByIds(Integer[] ids){
    if (positionService.deletePositionsByIds(ids) == ids.length){
      return RespBean.ok("删除成功!");
    }
    return RespBean.error("删除失败");
  }
}
```

* service层

```java
@Service
public class PositionService {

  @Autowired
  PositionMapper positionMapper;
  
  // 省略其余方法

  public Integer deletePositionsByIds(Integer[] ids) {
    return positionMapper.deletePositionsByIds(ids);
  }
}
```

* Mapper层

```java
public interface PositionMapper {
  // 省略其余方法
  Integer deletePositionsByIds(@Param("ids") Integer[] ids);
}
```

```xml
<delete id="deletePositionsByIds">
  delete from position where id in
  <foreach collection="ids" item="id" separator="," open="(" close=")">
    #{id}
  </foreach>
</delete>
```

---

前端

注意：前端往后端发送数组的链接为：`/system/basic/pos/?ids=43&ids=42&ids=41&`

* 这里省略了部分未更新的代码

```vue
<template>
<el-table
          :data="positions"
          stripe
          size="small"
          border
          style="width: 70%"
          @selection-change="handleSelectionChange">
  <el-table-column
                   type="selection"
                   width="55">
  </el-table-column>
  </el-table>
<!-- 设置了当未点击编号的时候为disabled，无法点击状态 -->
<el-button type="danger" @click="deleteMany" size="small" style="margin-top: 8px;"
           :disabled="multipleSelection.length==0">批量删除
  </el-button>
</template>
<script>
  export default {
    name: "PosMana",
    data() {
      return {
        pos: {
          name: '',
        },
        updatePos: {
          name: '',
        },
        positions: [],
        dialogVisible: false,
        multipleSelection: []
      }
    },
    mounted() {
      this.initPositions();
    },
    methods: {
      // 当编号被选中的时候将会将 `此行数据` 的所有信息赋值给 this.multipleSelection 
      handleSelectionChange(val) {
        this.multipleSelection = val
      },
      // 点击批量删除操作
      deleteMany() {
        this.$confirm('此操作将永久删除【' + this.multipleSelection.length + '】几条记录, 是否继续?', '提示', {
          confirmButtonText: '确定',
          cancelButtonText: '取消',
          type: 'warning'
        }).then(() => {
          let ids = "?";
          // 拼接链接，将参数拼接到链接上
          this.multipleSelection.forEach(item => {
            ids += "ids=" + item.id + "&"
          })
          this.deleteRequest("/system/basic/pos/" + ids).then(res => {
            if (res) {
              this.initPositions();
            }
          })
        }).catch(() => {
          this.$message({
            type: 'info',
            message: '已取消删除'
          });
        });
      }
    }
  }
</script>
```

